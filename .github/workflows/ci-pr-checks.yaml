name: CI - PR Checks

# Cancel previous runs on the same PR when new commits are pushed
# This prevents multiple CI runs from running simultaneously for the same PR
concurrency:
  group: ci-pr-checks-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

on:
  pull_request:
    branches:
      - main
      - dev
  # Allow manual triggering of full e2e tests
  workflow_dispatch:
    inputs:
      run_full_tests:
        description: 'Run full e2e test suite on Kind (default: smoke tests only)'
        required: false
        default: false
        type: boolean
  # Allow triggering via PR comments
  issue_comment:
    types: [created]

jobs:
  # Check if PR contains code changes (not just docs/metadata)
  check-code-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      has_code_changes: ${{ steps.filter.outputs.code }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
      
      - name: Check for code changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - '!docs/**'
              - '!README.md'
              - '!CONTRIBUTING.md'
              - '!LICENSE'
              - '!OWNERS'
              - '!PROJECT'

  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Sanity check repo contents
        run: ls -la

      - name: Extract Go version from go.mod
        run: sed -En 's/^go (.*)$/GO_VERSION=\1/p' go.mod >> $GITHUB_ENV

      - name: Set up Go with cache
        uses: actions/setup-go@v5
        with:
          go-version: "${{ env.GO_VERSION }}"
          cache-dependency-path: ./go.sum

      - name: Install dependencies
        run: go mod download

      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.8.0
          args: ""

      - name: Run make build
        shell: bash
        run: |
          make build

      - name: Run make test
        shell: bash
        run: |
          make test

  # Check if full e2e tests should run (via workflow_dispatch or comment trigger)
  check-full-tests:
    runs-on: ubuntu-latest
    outputs:
      run_full: ${{ steps.check.outputs.run_full }}
    steps:
      - name: Check if full tests requested
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            // Check workflow_dispatch input
            const workflowInput = '${{ github.event.inputs.run_full_tests }}';
            // Handle both boolean and string inputs
            if (workflowInput === 'true' || workflowInput === true || workflowInput === 'True') {
              core.setOutput('run_full', 'true');
              return;
            }
            
            // Check for /test-full comment trigger
            if (context.eventName === 'issue_comment') {
              const comment = context.payload.comment.body.trim().toLowerCase();
              if (comment === '/test-full' || comment === '/test-full-kind') {
                // Verify user has write access
                const username = context.payload.comment.user.login;
                try {
                  const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    username: username
                  });
                  const privilegedRoles = ['admin', 'maintain', 'write'];
                  if (privilegedRoles.includes(permission.permission)) {
                    core.setOutput('run_full', 'true');
                    return;
                  }
                } catch (e) {
                  console.log('Could not verify permissions:', e);
                }
              }
            }
            
            core.setOutput('run_full', 'false');

  # E2E tests - smoke tests run automatically, full tests on approval
  # Skip e2e tests if PR only contains docs/metadata changes
  e2e-tests:
    runs-on: ubuntu-latest
    needs: [lint-and-test, check-code-changes, check-full-tests]
    if: |
      needs.check-code-changes.outputs.has_code_changes == 'true' ||
      needs.check-full-tests.outputs.run_full == 'true'
    timeout-minutes: 60
    permissions:
      contents: read
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Extract Go version from go.mod
        run: sed -En 's/^go (.*)$/GO_VERSION=\1/p' go.mod >> $GITHUB_ENV

      - name: Set up Go with cache
        uses: actions/setup-go@v5
        with:
          go-version: "${{ env.GO_VERSION }}"
          cache-dependency-path: ./go.sum

      - name: Install dependencies
        run: go mod download

      - name: Install Kind
        run: |
          ARCH=$(uname -m)
          case "$ARCH" in
            x86_64)  KIND_ARCH="amd64" ;;
            aarch64) KIND_ARCH="arm64" ;;
            *)       echo "Unsupported architecture: $ARCH"; exit 1 ;;
          esac
          curl -Lo ./kind "https://kind.sigs.k8s.io/dl/v0.25.0/kind-linux-${KIND_ARCH}"
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build WVA image locally
        id: build-image
        run: |
          # Generate unique image tag for this PR run (local image, no registry needed)
          IMAGE_NAME="llm-d-workload-variant-autoscaler"
          IMAGE_TAG="pr-${GITHUB_RUN_ID}-${GITHUB_SHA:0:7}"
          # Use localhost prefix for local-only image (Kind will load it directly)
          FULL_IMAGE="localhost/${IMAGE_NAME}:${IMAGE_TAG}"
          
          echo "Building local image: $FULL_IMAGE"
          echo "Image will be loaded into Kind cluster (no push needed)"
          
          # Build image locally (no push needed for Kind)
          make docker-build IMG="$FULL_IMAGE"
          
          echo "image=$FULL_IMAGE" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Image built locally: $FULL_IMAGE"

      - name: Determine test type
        id: test-type
        run: |
          if [ "${{ needs.check-full-tests.outputs.run_full }}" == "true" ]; then
            echo "test_target=test-e2e-full-with-setup" >> $GITHUB_OUTPUT
            echo "test_name=full" >> $GITHUB_OUTPUT
            echo "scale_to_zero=true" >> $GITHUB_OUTPUT
            echo "delete_cluster=false" >> $GITHUB_OUTPUT
          else
            echo "test_target=test-e2e-smoke-with-setup" >> $GITHUB_OUTPUT
            echo "test_name=smoke" >> $GITHUB_OUTPUT
            echo "scale_to_zero=false" >> $GITHUB_OUTPUT
            echo "delete_cluster=true" >> $GITHUB_OUTPUT
          fi

      - name: Run e2e tests (${{ steps.test-type.outputs.test_name }})
        shell: bash
        env:
          ENVIRONMENT: kind-emulator
          USE_SIMULATOR: "true"
          SCALE_TO_ZERO_ENABLED: ${{ steps.test-type.outputs.scale_to_zero }}
          CREATE_CLUSTER: "true"
          INSTALL_GATEWAY_CTRLPLANE: "true"
          E2E_TESTS_ENABLED: "true"
          IMG: ${{ steps.build-image.outputs.image }}
          SKIP_BUILD: "true"
          PROMETHEUS_ADAPTER_WAIT: "false"
          DELETE_CLUSTER: ${{ steps.test-type.outputs.delete_cluster }}
        run: |
          make ${{ steps.test-type.outputs.test_target }}
