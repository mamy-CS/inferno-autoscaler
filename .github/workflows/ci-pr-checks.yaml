name: CI - PR Checks

on:
  pull_request:
    branches:
      - main
      - dev

jobs:
  # Check if PR contains code changes (not just docs/metadata)
  check-code-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      has_code_changes: ${{ steps.filter.outputs.code }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
      
      - name: Check for code changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - '!docs/**'
              - '!README.md'
              - '!CONTRIBUTING.md'
              - '!LICENSE'
              - '!OWNERS'
              - '!PROJECT'

  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Sanity check repo contents
        run: ls -la

      - name: Extract Go version from go.mod
        run: sed -En 's/^go (.*)$/GO_VERSION=\1/p' go.mod >> $GITHUB_ENV

      - name: Set up Go with cache
        uses: actions/setup-go@v5
        with:
          go-version: "${{ env.GO_VERSION }}"
          cache-dependency-path: ./go.sum

      - name: Install dependencies
        run: go mod download

      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.8.0
          args: ""

      - name: Run make build
        shell: bash
        run: |
          make build

      - name: Run make test
        shell: bash
        run: |
          make test

  # E2E tests run in parallel with different configurations:
  # - HPAScaleToZero feature gate settings (true/false)
  # - GPU types (nvidia/amd) for limiter tests
  # Skip e2e tests if PR only contains docs/metadata changes
  e2e-tests:
    runs-on: ubuntu-latest
    needs: [lint-and-test, check-code-changes]
    if: needs.check-code-changes.outputs.has_code_changes == 'true'
    timeout-minutes: 60
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Extract Go version from go.mod
        run: sed -En 's/^go (.*)$/GO_VERSION=\1/p' go.mod >> $GITHUB_ENV

      - name: Set up Go with cache
        uses: actions/setup-go@v5
        with:
          go-version: "${{ env.GO_VERSION }}"
          cache-dependency-path: ./go.sum

      - name: Install dependencies
        run: go mod download

      - name: Install Kind
        run: |
          ARCH=$(uname -m)
          case "$ARCH" in
            x86_64)  KIND_ARCH="amd64" ;;
            aarch64) KIND_ARCH="arm64" ;;
            *)       echo "Unsupported architecture: $ARCH"; exit 1 ;;
          esac
          curl -Lo ./kind "https://kind.sigs.k8s.io/dl/v0.25.0/kind-linux-${KIND_ARCH}"
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push WVA image
        id: build-image
        run: |
          # Generate unique image tag for this PR run
          IMAGE_NAME="llm-d-workload-variant-autoscaler"
          REGISTRY="ghcr.io/llm-d"
          GIT_REF="${GITHUB_REF#refs/heads/}"
          GIT_REF_SANITIZED=$(echo "$GIT_REF" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
          IMAGE_TAG="pr-${GITHUB_RUN_ID}-${GITHUB_SHA:0:7}"
          FULL_IMAGE="${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
          
          echo "Building image: $FULL_IMAGE"
          echo "Git ref: $GIT_REF"
          
          # Build and push using make targets
          make docker-build IMG="$FULL_IMAGE"
          make docker-push IMG="$FULL_IMAGE"
          
          echo "image=$FULL_IMAGE" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Image built and pushed: $FULL_IMAGE"

      - name: Run smoke e2e tests
        shell: bash
        env:
          ENVIRONMENT: kind-emulator
          USE_SIMULATOR: "true"
          SCALE_TO_ZERO_ENABLED: "false"
          CREATE_CLUSTER: "true"
          INSTALL_GATEWAY_CTRLPLANE: "true"
          E2E_TESTS_ENABLED: "true"
          IMG: ${{ steps.build-image.outputs.image }}
          DELETE_CLUSTER: "true"
        run: |
          make test-e2e-smoke-with-setup
